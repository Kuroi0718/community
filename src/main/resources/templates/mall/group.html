<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org/">
<head>
<meta charset="UTF-8">
<title>團購商品</title>
<style>
.square2,.square{
border:1px grey solid;
background-color:#D8D8EB;
}
.square2:hover,.square:hover{
transform:scale(1.05);
}
.square2:active,.square:active{
transform:scale(1);
}

.square{
width:40px;
height:40px;
}
.square{
border-radius:0.375rem;
}
</style>
</head>
<body style="overflow:hidden;background-color:#EAE0D5">
<div th:replace="~{mall/nav}"></div>
<div id="group"
		style="filter: none; position: absolute; z-index: -2; width: 100vw">
		<div style="height: 88vh; width: 100vw; overflow-y: scroll;scroll-behavior:smooth;">
			<div style="display: flex; flex-direction: column">
<!---------------------------------- --------------------------------------->
				<div class="box1" id="top" 
					style="height: 20vh; width: 100%;"><!---測試框--->
					
				</div>
<!----------------------------------------------------------------------->
					


				<div style="display: flex; flex-direction: row">
<!-------------**************************分享*************************-------------------->
				<div  id="shareProduct" style="position:absolute;z-index:3;background:linear-gradient(to bottom, white 0%, #66B3FF 100%);width:420px;height:400px;left:40%;display:none;overflow-y:scroll;padding-bottom:50px;padding-top:50px;border-radius:10px;border:2px silver solid">
					<figure>
					<input type="checkbox" style="width:50px;height: 80px;position:absolute;margin-left:50px" value="Id">
					<div id="share" style="width: 200px; height: 80px; margin: auto;margin-top:20px;border: 1px solid silver;background-color:#F2EFE9;">
					<div style="position:absolute;margin-top:30px;margin-left:30px">name</div>
					<img src="../image/noimg.png"  style="width:70px;float:right;margin:5px">
					</div>
					</figure>
					<div style="display: flex; flex-direction: row">
					<button id="closeShareButton" style="width:90px; height: 50px; margin-left:100px;margin-top:20px;" onclick="closeShareProduct()">取消</button>
					<button style="width:90px; height:50px; margin-left:20px;margin-top:20px;">分享</button>
					</div>
					<input id="shareContent" value=""></input>
				</div>

<!----------------------------------CARD --------------------------------------->
					<th:block th:switch="${groupList != null}">
						<div th:case="${true}"
							style="display: inline-flex; flex-direction: row; flex-wrap: wrap;padding:65px">
							<th:block th:each="p : ${groupList}">

								<div class="card"
									style="width: 20rem; height: 25rem; margin: 10px; border: 1px solid silver;background-color:#F2EFE9">
									<div
										style="width: 13rem; height: 13rem; overflow: hidden; margin: auto; border: 1px solid silver; border-radius: 0.375rem;">
										<th:block th:switch="${p.quantity > 0}">
										<img th:case="${true}" th:id="${'img_'+p.productId}" th:src="@{'/mall/showPhoto?productId=' + ${p.productId}}"
											style="width: 13rem; height: 13rem;">
										<img th:case="${false}" th:id="${'img_'+p.productId}" th:src="@{'/mall/showPhoto?productId=' + ${p.productId}}"
											style="width: 13rem; height: 13rem;filter:opacity(0.2)">
										</th:block>
									</div><span style="position:absolute;">Id:[[${p.productId}]]</span>
									<div class="" style="width: 20rem;"><!--內容 -->
										
										<div style="margin-left:3.5rem">商品名稱:[[${p.productName}]]</div>
										<div style="margin-left:3.5rem">價格:NT$[[${p.price}]]元</div>
										<div style="margin-left:3.5rem">商品描述:[[${p.info}]]<br></div>
										<div style="margin-left:3.5rem">還差<span th:id="${'Quantity_'+p.productId}">[[${p.quantity}]]份達標</span></div>
										<div style="margin-left:3.5rem">剩餘時間:<span th:class="${p.productId}"></span></div>
										<div
											style="display: flex; flex-direction: column; max-width: 20rem;">
											<th:block th:switch="${session.loggedInMember != null}">
												<div th:case="${true}" style="display: flex; flex-direction: row;">


													<a
														th:href="@{'/mall/productPage?productId=' + ${p.productId}}"><button
															class="square"
															th:onclick="addToMyRecord([[${p.productId}]])">
															<img th:src="@{/image/eye.png}">
														</button></a>
													<button class="square"
														th:onclick="addToMyLikes([[${p.productId}]])">
														<img th:id="${'likes_'+p.productId}" th:src="@{'/mall/showLike?productId=' + ${p.productId}}">
													</button>
													<button class="square" th:onclick="findMyFriendList([[${p.productId}]])">
														<img th:src="@{/image/arrow.png}">
													</button>
													<form th:id="${p.productId}"
														th:action="@{/mall/addToMyCart}"
														enctype="multipart/form-data" method="post">
														<label for="amount">買</label>
														<input type="number" id="amount" name="amount" step=1
															min=0 max=999999 style="width: 2vw; height: 3vh" value="1" oninput="if(this.value<=0)value=1"></input>個
														<input type="hidden" id="myCartProductId"
															name="myCartProductId" th:value="${p.productId}"></input>
																
														<th:block th:switch="${p.quantity > 0}">		
														<button class="square2" th:case="${true}" type="button" th:id="${'addToCartButton_'+p.productId}" 
															th:onclick="addToMyCart([[${p.productId}]])"
															style="height: 40px; border-radius: 0.375rem;font-weight:bold;">加入購物車</button>
														<button class="square2" th:case="${false}" type="button" th:id="${'addToCartButton_'+p.productId}" 
															style="height: 40px; border-radius: 0.375rem;font-weight:bold" disabled>加入購物車</button>
														</th:block>
													</form>
												</div>
												<div th:case="${false}" style="display:flex;flex-direction:row">
													<button disabled class="square">
														<img th:src="@{/image/eye.png}">
													</button>
													<button disabled class="square">
														<img th:src="@{/image/heart0.png}">
													</button>
													<button disabled class="square">
														<img th:src="@{/image/arrow.png}">
													</button>
													<div style="line-height:40px;">
													<label for="amount" >買</label>
													<input type="number" id="amount" name="amount" step=1
															min=0 max=999999 value="1" style="width: 2vw; height: 3vh;"></input>個
													</div>
													<button class="square2" disabled
														style="height: 40px; border-radius: 0.375rem;font-weight:bold">加入購物車</button>
												</div>
										</div>
									</div>
								</div>

							</th:block>
						</div>
					</th:block>
					<!--<th:block th:switch="${loggedInMember.level=='admin'}">
								<div th:case="${true}">
								<a href="#"><button>Delist</button></a>
								</div>
							<img class="${p.pid}" id="likeB" onclick="like(this.className)"
								src=""
								style="border: none; width: 55px; height: 55px;" />
								

<!----------------------------------CARD --------------------------------------->
					<div id="demo"></div>
				</div>
			</div>
<!-----right--buttons--------------------------->			
	<a th:href="@{/ad/displayImage}"><button style="width:50px;height:50px;border-radius:0.375rem;background-color:#BDB4BF;position:fixed;right:35px;bottom:30px;background-image:url('../image/home.png');background-repeat:no-repeat;background-position:center;border:grey 1px solid"></button></a>
	<a th:href="@{/mall/mePage}"><button id="cartId" style="width:50px;height:50px;border-radius:0.375rem;background-color:#BDB4BF;position:fixed;right:35px;bottom:90px;background-image:url('../image/cart.png');background-repeat:no-repeat;background-position:center;border:grey 1px solid"></button></a>
	<a href="#top"><button style="width:50px;height:50px;border-radius:0.375rem;background-color:#BDB4BF;position:fixed;right:35px;bottom:150px;background-image:url('../image/up.png');background-repeat:no-repeat;background-position:center;border:grey 1px solid"></button></a>
	
	<th:block th:switch="${session.loggedInMember != null}">
	<div id="cartNum" th:case="${true}" style="display:none;width:25px;height:25px;border-radius:25px;background-color:red;position:fixed;right:25px;bottom:125px;z-index:1;text-align:center;color:#EAE0D5;font-weight:bold">[[${num}]]</div>
	</th:block>	
<!-----right--buttons--------------------------->
		</div>
	</div>
	<div id="addToCartAlert" style="position:absolute;background-color:black;width:300px;height:100px;display:none;bottom:30px;right:0px;font-size:40px;font-weight:bold;color:white;text-align:center;padding-top:25px;border-top-left-radius:10px;border-bottom-left-radius:10px">
    	已加入購物車
    </div>
<script>
function closeShareProduct(){
let shareProduct = document.getElementById('shareProduct');
shareProduct.style.display='none';
}
</script>
<script>
let shareProduct = document.getElementById('shareProduct');
function findMyFriendList(pid){
let xhttp = new XMLHttpRequest();
xhttp.onload = function(){
shareProduct.innerHTML = xhttp.responseText;
shareProduct.style.display='block';
}
xhttp.open("POST","http://localhost:8080/community/mall/findMyFriendList",true);
xhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
xhttp.send("productId="+pid);
}
</script> 
<script>
function sendShareList() {
let shareProductId = document.getElementById('shareProductId');
let checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
checkboxes.forEach(function(checkbox){
console.log(checkbox.value);
shareList(checkbox.value,'<a href="/community/mall/productPage?productId='+shareProductId.value+'">看看這個!!</a>');
})
let shareProduct = document.getElementById('shareProduct');
shareProduct.style.display='none';
}

function shareList(mid,content) {
let formdata = new FormData();
formdata.append('target',mid);
formdata.append('content',content);
	let xhrForm = new XMLHttpRequest();
	xhrForm.onload = function() {
		let websocketMessage = {
			id: myId.value,
			target: mid,
			type: 1
		};
		websocket.send(JSON.stringify(websocketMessage));
		appendMessage(0, messageInput.value.trim(), xhrForm.responseText, "self");
		messageInput.value = "";
		messageInput.focus();
		part.value = "";
	}
	xhrForm.open("POST", "/community/message/shareMessage", true);
	xhrForm.send(formdata);
}
</script>
<script>
function timeLimitTest(){
let form = document.getElementById('timeLimitTestForm');
let formdata = new FormData(form);
let xhttp = new XMLHttpRequest();
xhttp.onload = function(){
location.reload();
}
xhttp.open("POST","http://localhost:8080/community/mall/timeLimitTest",true);
xhttp.send(formdata);
}
</script>	
<script>
function numberTest(){
let form = document.getElementById('numberTestForm');
let formdata = new FormData(form);
let xhttp = new XMLHttpRequest();
xhttp.onload = function(){
location.reload();
}
xhttp.open("POST","http://localhost:8080/community/mall/numberTest",true);
xhttp.send(formdata);
}
</script>

<script>
let result="";
let result2="";

groupGetTime1();
groupGetTime2();

function groupGetTime1(){
let xhttp = new XMLHttpRequest();
xhttp.onload = function(){
result = JSON.parse(xhttp.responseText);
if(result!=""&&result2!=""){
for(let i=0;i<result.length;i++){
time(result2[i],result[i].productId);
}
}
}
xhttp.open("POST","http://localhost:8080/community/mall/groupGetTime",true);
xhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
xhttp.send();
}

function groupGetTime2(){
let xhttp2 = new XMLHttpRequest();
xhttp2.onload = function(){
result2 = JSON.parse(xhttp2.responseText);
if(result!=""&&result2!=""){
for(let i=0;i<result.length;i++){
time(result2[i],result[i].productId);
}
}
}
xhttp2.open("POST","http://localhost:8080/community/mall/groupGetTime2",true);
xhttp2.setRequestHeader("Content-type","application/x-www-form-urlencoded");
xhttp2.send();
}


function time(str, pid){
// Set the date we're counting down to
let countDownDate = new Date(str).getTime();

// Update the count down every 1 second
let x = setInterval(function() {

  // Get today's date and time
  let now = new Date().getTime();

  // Find the distance between now and the count down date
  let distance = countDownDate - now;

  // Time calculations for days, hours, minutes and seconds
  let days = Math.floor(distance / (1000 * 60 * 60 * 24));
  let hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  let minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
  let seconds = Math.floor((distance % (1000 * 60)) / 1000);

  // Display the result in the element with id="countdownTimer"
  document.getElementsByClassName(pid)[0].innerHTML = days + "日 " + hours + "時 "
  + minutes + "分 " + seconds + "秒 ";

  // If the count down is finished, write some text
  if (distance < 0) {
    clearInterval(x);
    document.getElementsByClassName(pid)[0].innerHTML = "團購已結束";
    document.getElementById('img_'+pid).style.filter='opacity(0.2)';
    document.getElementById('addToCartButton_'+pid).disabled=true;
  }
}, 1000);

}
</script>	
<script>
let cartNum = document.getElementById("cartNum")
if(cartNum.innerHTML!=0){
cartNum.style.display='block';
}

function addToMyCart(pid){
let form = document.getElementById(pid);
let formdata = new FormData(form);
let xhttp = new XMLHttpRequest();
xhttp.onload = function(){
document.getElementById("addToCartAlert").style.display='block';
setTimeout(function() {
document.getElementById("addToCartAlert").style.display='none';
}, 1000);



cartNum.style.display='block';
cartNum.innerHTML = xhttp.responseText;
}
xhttp.open("POST","http://localhost:8080/community/mall/addToMyCart",true);
xhttp.send(formdata);
}
</script>
	<script>
function addToMyRecord(pid){
console.log(pid);
let xhttp = new XMLHttpRequest();
xhttp.open("POST","http://localhost:8080/community/mall/addToMyRecord",true);
xhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
xhttp.send("productId="+pid);
}
</script>
<script>
function addToMyLikes(pid){
let img = document.getElementById('likes_'+pid);
let xhttp = new XMLHttpRequest();
xhttp.onload = function(){
let str = xhttp.responseText;
if(str==='0'){
	img.src='/community/image/heart.png';
}else{
	img.src='/community/image/heart0.png';
}
}
xhttp.open("POST","http://localhost:8080/community/mall/addToMyLikes",true);
xhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
xhttp.send("productId="+pid);
}
</script>
<script>
let all = document.getElementById('group');
 all.addEventListener("mouseover",function(){
        all.style.filter = "none";
 })
 div1.addEventListener("mouseover",function(){
        all.style.filter = "blur(5px)";
 })
 div2.addEventListener("mouseover",function(){
        all.style.filter = "blur(5px)";
 })
</script>
</body>
</html>